<link rel="import" href="../../bower_components/polymer/polymer.html">

<script type="text/javascript" src="../../scripts/date-fi-FI.js"></script>

<dom-module id="project-timeline">
    <template>
        <vaadin-column-chart timeline id="timelineChart"
                             on-point-click="_pointClicked">
            <chart animation="true"></chart>

            <title>Project timeline</title>

            <tooltip header-format=""
                     point-formatter="function() {
                                    return '<span style=\'color:' + this.color + '\'>&#x25CF </span>'
                                    + '<b>Project: </b>' + this.series.name + '<br/>'
                                    + '<b> Note on ' + Highcharts.dateFormat('%d.%m.%Y', this.x) + ':</b><br/>'
                                    + '<span> ' + (this.name.length < 30 ? this.name : this.name.substring(0,30) + '...') + '</span>'
                                    + '<br/><br/>';}"
                     use-html="true"
                     x-date-format="%d.%m.%Y"></tooltip>

            <legend enabled="true"></legend>

            <x-axis type="datetime"
                    min-tick-interval="86400000"
                    crosshair="false">
            </x-axis>

            <y-axis visible="false"></y-axis>

            <plot-options>
                <column point-width="15"></column>
            </plot-options>

            <range-selector enabled="true"
                            input-date-format="%d.%m.%Y"
                            input-edit-date-format="%d.%m.%Y">
            </range-selector>

            <navigator>
                <series line-width="0"
                        type="line">
                </series>
            </navigator>

            <exporting enabled="false"></exporting>

        </vaadin-column-chart>
    </template>


    <script>
        Polymer({
            is: 'project-timeline',

            properties: {
                /**
                 * Object with project names as keys
                 * to an array of note objects. Those note objects
                 * have note and a date fields.
                 */
                data: Object,

                allNotes: String,

                timelinei18n: {
                    type: Object,
                    value: function () {
                        return {
                            monthNames: [
                                'January', 'February', 'March', 'April', 'May',
                                'June', 'July', 'August', 'September', 'October', 'November', 'December'
                            ],
                            weekdaysShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                            firstDayOfWeek: 1,
                            today: 'today',
                            cancel: 'cancel',
                            formatDate: function (d) {
                                return d.getDate() + '.' + (d.getMonth() + 1) + '.' + d.getFullYear();
                            }
                        };
                    }
                }
            },

            /**
             * Observe changes to the backend object.
             * Most of the changes are to add one note to a specific project.
             * Hence we need to monitor the whole object.
             */
            observers: [
                '_backendDataChanged(data.*)',
                '_updateNavigatorSeries(allNotes)'
            ],

            listeners: {

            },

            /**
             * Create a data-series element. Corresponds to one project
             *
             * @param name name of the project
             * @returns {Element} a new data-series element
             * @private
             */
            _createDataSeriesElement: function (name) {
                var dsElement = document.createElement('data-series');
                dsElement.setAttribute('id', this._getProjectNameAsId(name));
                dsElement.setAttribute('name', name);
                return dsElement;
            },

            /**
             * Create a data element, corresponds to the list of notes
             *
             * @param contentsArray list of note objects
             * @returns {Element} a new data element
             * @private
             */
            _createDataElement: function (contentsArray) {
                var dataElement = document.createElement('data');
                var jsonArray = JSON.stringify(contentsArray);
                dataElement.textContent = jsonArray.substring(1, jsonArray.length - 1);
                return dataElement;
            },

            /**
             * Update the series for the navigator below the chart. This series
             * is special, since it must contain all the dates from all the
             * projects, so that it can show the correct date range.
             *
             * @private
             */
            _updateNavigatorSeries: function (event) {
                var allNotes = event;
                var chart = this.$.timelineChart;

                var navigatorSeries = [];
                for (var i = 0; i < allNotes.length; i++) {
                    navigatorSeries.push([allNotes[i].date, 0]);
                }

                var newNavigatorSeriesDataElement = this._createDataElement(navigatorSeries);

                var chartElement = Polymer.dom(this.$.timelineChart);

                var navigatorSeriesElement = chartElement.querySelector('navigator series');

                var existingNavigatorSeriesDataElement = chartElement.querySelector('navigator series data');

                if (existingNavigatorSeriesDataElement) {
                    navigatorSeriesElement.removeChild(existingNavigatorSeriesDataElement);
                }

                navigatorSeriesElement.appendChild(newNavigatorSeriesDataElement);

                if (chart.isInitialized()) {
                    chart.reloadConfiguration();
                }
            },

            /**
             * Called when backend data changes. Figures out what exactly
             * changed and updates the chart DOM accordingly.
             *
             * @param valueChangeEvent event from Polymer signaling that
             *        something in the backend data changed
             * @private
             */
            _backendDataChanged: function (valueChangeEvent) {
                var allIsNewRegexp = /^data$/;
                var newProjectRegexp = /^data\.((\w|\s)*)$/;
                var newNoteRegexp = /^data\.(.*)\.splices$/;
                var noteUpdateRegexp = /^data\.(.*)\.#(\d*)$/;

                var chart = this.$.timelineChart;

                if (allIsNewRegexp.test(valueChangeEvent.path)) {
                    //everything changed, aka first load

                    var backendNotes = valueChangeEvent.base;

                    var allDataSeries = Polymer.dom(chart).querySelectorAll('data-series');

                    for (var i = 0; i < allDataSeries.length; i++) {
                        var dataSeries = allDataSeries[i];
                        Polymer.dom(chart).removeChild(dataSeries);
                    }

                    for (var project in backendNotes) {
                        if (backendNotes.hasOwnProperty(project)) {
                            var mappedData = this._mapBackendProjectData(backendNotes[project]);

                            var dsElement = this._createDataSeriesElement(project);
                            var dataElement = this._createDataElement(mappedData);
                            Polymer.dom(chart).appendChild(dsElement);
                            Polymer.dom(dsElement).appendChild(dataElement);
                        }
                    }

                } else if (newProjectRegexp.test(valueChangeEvent.path)) {
                    //new project added
                    var newProjectName = newProjectRegexp.exec(valueChangeEvent.path)[1];
                    var dsElement = this._createDataSeriesElement(newProjectName);
                    Polymer.dom(chart).appendChild(dsElement);

                } else if (newNoteRegexp.test(valueChangeEvent.path)) {
                    //new note added, update whole series
                    var existingProjectName = newNoteRegexp.exec(valueChangeEvent.path)[1];
                    var projectNoteArray = valueChangeEvent.value.indexSplices[0].object;
                    var mappedData = this._mapBackendProjectData(projectNoteArray);

                    var dataSeriesElement = Polymer.dom(chart).querySelector('#' + this._getProjectNameAsId(existingProjectName));
                    var existingSeriesDataElement = Polymer.dom(dataSeriesElement).querySelector('data');
                    if (existingSeriesDataElement) {
                        dataSeriesElement.removeChild(existingSeriesDataElement);
                    }

                    var newDataElement = this._createDataElement(mappedData);
                    Polymer.dom(dataSeriesElement).appendChild(newDataElement);
                } else if (noteUpdateRegexp.test(valueChangeEvent.path)) {
                    //old note updated, update whole series
                    var existingProjectName = noteUpdateRegexp.exec(valueChangeEvent.path)[1];
                    // TODO update just one note instead of whole array?
                    // var noteIndex = noteUpdateRegexp.exec(valueChangeEvent.path)[2];
                    var projectNoteArray = valueChangeEvent.base[existingProjectName];
                    var mappedData = this._mapBackendProjectData(projectNoteArray);

                    var dataSeriesElement = Polymer.dom(chart).querySelector('#' + this._getProjectNameAsId(existingProjectName));
                    var existingSeriesDataElement = Polymer.dom(dataSeriesElement).querySelector('data');
                    if (existingSeriesDataElement) {
                        dataSeriesElement.removeChild(existingSeriesDataElement);
                    }

                    var newDataElement = this._createDataElement(mappedData);
                    Polymer.dom(dataSeriesElement).appendChild(newDataElement);
                }

                if (chart.isInitialized()) {
                    chart.reloadConfiguration();
                }
            },

            /**
             * Map backend data format into something our chart expects.
             * The note date is the x value.
             *
             * @param backendProjectArray array of backend notes
             * @returns {Array} array of chart point objects
             * @private
             */
            _mapBackendProjectData: function (backendProjectArray) {
                var newArray = [];
                for (var i = 0; i < backendProjectArray.length; i++) {
                    var backendDataItem = backendProjectArray[i];
                    newArray.push({
                        x: backendDataItem.date,
                        name: backendDataItem.note,
                        y: Math.random() + 1,
                        noteId: backendDataItem.noteId
                    });
                }

                return newArray;
            },

            _pointClicked: function (event) {
                this.fire('project-timeline-point-click',{
                    id: event.detail.point.noteId,
                    project: event.detail.point.series.name,
                    date: new Date(event.detail.point.x),
                    note: event.detail.point.name
                });
            },

            _getProjectNameAsId: function (projectName) {
                function camelize(str) {
                    return str.replace(/(?:^\w|[A-Z]|\b\w)/g, function (letter, index) {
                        return index == 0 ? letter.toLowerCase() : letter.toUpperCase();
                    }).replace(/\s+/g, '');
                }

                return camelize(projectName);
            }

        });
    </script>
</dom-module>
