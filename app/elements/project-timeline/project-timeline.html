<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="project-timeline">
    <template>
        <vaadin-column-chart timeline id="timelineChart"
                             on-point-click="_pointClicked">
            <chart animation="true"></chart>

            <title>Project timeline</title>

            <tooltip header-format=""
                     point-formatter="function() {
                                    return '<span style=\'color:' + this.color + '\'>&#x25CF </span>'
                                    + '<b>Project: </b>' + this.series.name + '<br/>'
                                    + '<b> Note on ' + moment(this.x).format(moment.localeData().longDateFormat('L')) + ':</b><br/>'
                                    + '<span> ' + (this.name.length < 30 ? this.name : this.name.substring(0,30) + '...') + '</span>'
                                    + '<br/><br/>';}"
                     use-html="true"
                     x-date-format="%d.%m.%Y"></tooltip>

            <legend enabled="true"></legend>

            <x-axis type="datetime"
                    min-tick-interval="86400000"
                    crosshair="false">
            </x-axis>

            <y-axis visible="false"></y-axis>

            <plot-options>
                <column point-width="15"></column>
            </plot-options>

            <range-selector enabled="true"
                            input-date-format="%d.%m.%Y"
                            input-edit-date-format="%d.%m.%Y">
            </range-selector>

            <navigator>
                <series line-width="0"
                        type="line"
                        id="navigator">
                </series>
            </navigator>

            <exporting enabled="false"></exporting>

        </vaadin-column-chart>
    </template>


    <script>
        Polymer({
            is: 'project-timeline',

            properties: {
                projects: Array,

                notes: Array,

                _notesLoaded: {
                    type: Boolean,
                    value: false
                }
            },

            /**
             * Observe changes to the backend object.
             * Most of the changes are to add one note to a specific project.
             * Hence we need to monitor the whole object.
             */
            observers: [
                '_notesChanged(notes.*)',
                '_projectsChanged(projects.*)'
            ],

            listeners: {},

            attached: function () {
                if (this._isChartLoaded() && !this._notesLoaded) {
                    this.$.timelineChart.chart.showLoading();
                }
            },

            /**
             * Called when backend data changes. Figures out what exactly
             * changed and updates the chart accordingly.
             *
             * @param event event from Polymer signaling that
             *        something in the backend notes changed
             * @private
             */
            _notesChanged: function (event) {
                console.log("Notes changed: " + event);

                if (!event.base || event.base.length == 0) {
                    return;
                }

                if (!this._isChartLoaded()) {
                    // chart not rendered, create elements
                    var notes = event.base;
                    this._createChartDataElements(notes);

                } else if ("notes" === event.path) {
                    this._addNotesToChart(event.base);

                } else if (event.value.indexSplices.length > 1) {
                    var newNotes = [];
                    for (var i = 0; i < event.value.indexSplices.length; i++) {
                        var newNoteIndex = event.value.indexSplices[i].index;
                        var newNote = event.value.indexSplices[i].object[newNoteIndex];
                        newNotes.push(newNote);
                    }

                    this._addNotesToChart(newNotes);

                } else if (event.value.indexSplices.length == 1) {
                    var newNoteIndex = event.value.indexSplices[0].index;
                    var newNote = event.value.indexSplices[0].object[newNoteIndex];
                    this._addNoteToChart(newNote, true);
                }

                this._updateNavigatorSeries(event);

                this._notesLoaded = true;

                if (this._isChartLoaded()) {
                    this.$.timelineChart.chart.hideLoading();
                }
            },

            _projectsChanged: function (event) {
                console.log("Projects changed: " + event);
            },

            /**
             * Update the series for the navigator below the chart. This series
             * is special, since it must contain all the dates from all the
             * projects, so that it can show the correct date range.
             *
             * @private
             */
            _updateNavigatorSeries: function (event) {
                if (!this._isChartLoaded()) {
                    // chart not rendered, create elements
                    var notes = event.base;

                    var navigatorSeries = [];
                    for (var i = 0; i < notes.length; i++) {
                        navigatorSeries.push([notes[i].date, 0]);
                    }

                    var newNavigatorSeriesDataElement = this._createDataElement(navigatorSeries);

                    var chartElement = Polymer.dom(this.$.timelineChart);

                    var navigatorSeriesElement = chartElement.querySelector('navigator series');

                    var existingNavigatorSeriesDataElement = chartElement.querySelector('navigator series data');

                    if (existingNavigatorSeriesDataElement) {
                        navigatorSeriesElement.removeChild(existingNavigatorSeriesDataElement);
                    }

                    navigatorSeriesElement.appendChild(newNavigatorSeriesDataElement);

                } else if (event.path === "notes") {
                    var navigatorNotes = event.base.slice();
                    for (var i = 0; i < navigatorNotes; i++) {
                        navigatorNotes[i].project.name = "navigator";
                    }

                    this._addNotesToChart(navigatorNotes);

                } else if (event.value.indexSplices.length > 1) {
                    var newNotes = [];
                    for (var i = 0; i < event.value.indexSplices.length; i++) {
                        var newNoteIndex = event.value.indexSplices[i].index;
                        var newNote = event.value.indexSplices[i].object[newNoteIndex];
                        newNote.project.name = "navigator";
                        newNotes.push(newNote);
                    }
                    this._addNotesToChart(newNotes);

                } else if (event.value.indexSplices.length == 1) {
                    var newNoteIndex = event.value.indexSplices[0].index;
                    var newNote = event.value.indexSplices[0].object[newNoteIndex];
                    newNote.name = "navigator";
                    this._addNoteToChart(newNote, true);
                }
            },

            _isChartLoaded: function () {
                return this.$.timelineChart.isInitialized();
            },

            _addNotesToChart: function (notes) {
                for (var i = 0; i < notes.length; i++) {
                    this._addNoteToChart(notes[i], false);
                }

                this.$.timelineChart.chart.redraw();
            },

            _addNoteToChart: function (newNote, redraw) {
                var chart = this.$.timelineChart.chart;

                var projectName = newNote.project.name;
                var projectNameAsId = this._getProjectNameAsId(projectName);
                var noteSeries = chart.get(projectNameAsId);

                if (noteSeries == null) {
                    noteSeries = chart.addSeries({
                        name: projectName,
                        id: projectNameAsId
                    }, redraw);
                }

                console.log("Add point " + JSON.stringify(newNote));

                noteSeries.addPoint({
                    x: newNote.date,
                    name: newNote.note,
                    y: Math.random() + 1,
                    noteId: newNote.noteId
                }, redraw);
            },

            _createChartDataElements: function (notes) {
                var chart = this.$.timelineChart;

                var projectsAndNotes = {};
                for (var i = 0; i < notes.length; i++) {
                    var note = notes[i];
                    if (!projectsAndNotes[note.project.name]) {
                        projectsAndNotes[note.project.name] = [];
                    }

                    projectsAndNotes[note.project.name].push(notes[i]);
                }

                for (var project in projectsAndNotes) {
                    if (projectsAndNotes.hasOwnProperty(project)) {
                        var mappedData = this._mapBackendProjectData(projectsAndNotes[project]);

                        var dsElement = this._createDataSeriesElement(project);
                        var dataElement = this._createDataElement(mappedData);
                        Polymer.dom(chart).appendChild(dsElement);
                        Polymer.dom(dsElement).appendChild(dataElement);
                    }
                }
            },

            /**
             * Map backend data format into something our chart expects.
             * The note date is the x value.
             *
             * @param backendProjectArray array of backend notes
             * @returns {Array} array of chart point objects
             * @private
             */
            _mapBackendProjectData: function (backendProjectArray) {
                var newArray = [];
                for (var i = 0; i < backendProjectArray.length; i++) {
                    var backendDataItem = backendProjectArray[i];
                    newArray.push({
                        x: backendDataItem.date,
                        name: backendDataItem.note,
                        y: Math.random() + 1,
                        noteId: backendDataItem.noteId
                    });
                }

                console.log(newArray);

                return newArray;
            },

            _pointClicked: function (event) {
                this.fire('project-timeline-point-click', {
                    id: event.detail.point.noteId,
                    project: event.detail.point.series.name,
                    date: event.detail.point.x,
                    note: event.detail.point.name
                });
            },

            _getProjectNameAsId: function (projectName) {
                function camelize(str) {
                    return str.replace(/(?:^\w|[A-Z]|\b\w)/g, function (letter, index) {
                        return index == 0 ? letter.toLowerCase() : letter.toUpperCase();
                    }).replace(/\s+/g, '');
                }

                return camelize(projectName);
            },

            /**
             * Create a data-series element. Corresponds to one project
             *
             * @param name name of the project
             * @returns {Element} a new data-series element
             * @private
             */
            _createDataSeriesElement: function (name) {
                var dsElement = document.createElement('data-series');
                dsElement.setAttribute('id', this._getProjectNameAsId(name));
                dsElement.setAttribute('name', name);
                return dsElement;
            },

            /**
             * Create a data element, corresponds to the list of notes
             *
             * @param contentsArray list of note objects
             * @returns {Element} a new data element
             * @private
             */
            _createDataElement: function (contentsArray) {
                var dataElement = document.createElement('data');
                var jsonArray = JSON.stringify(contentsArray);
                dataElement.textContent = jsonArray.substring(1, jsonArray.length - 1);
                return dataElement;
            }
        });
    </script>
</dom-module>
